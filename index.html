<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Moon Jumper</title>
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        body {
            font-family: 'Exo 2', sans-serif;
            overflow: hidden;
            background-color: #87CEEB;
        }
        
        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }
        
        #game-world {
            position: absolute;
            width: 100%;
            height: 300%;
            bottom: 0;
            left: 0;
        }
        
        #sky-bg {
            position: absolute;
            width: 100%;
            height: 300%;
            top: 0;
            left: 0;
            background: linear-gradient(to top, #87CEEB 0%, #1a237e 60%, #0a0a2a 85%);
            z-index: 1;
            transition: background-color 4s;
        }
        
        #sun {
            position: absolute;
            width: 80px;
            height: 80px;
            background: radial-gradient(circle, #FFF176 20%, #FFD54F 50%, #FFB300 100%);
            border-radius: 50%;
            z-index: 2;
            box-shadow: 0 0 30px #FFD54F;
            top: 50px;
            right: 50px;
            transition: all 2s;
        }
        
        #moon {
            position: absolute;
            width: 100px;
            height: 100px;
            background: radial-gradient(circle, #ECEFF1 30%, #CFD8DC 70%, #B0BEC5 100%);
            border-radius: 50%;
            z-index: 2;
            box-shadow: 0 0 20px #CFD8DC;
            top: -120px;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .cloud {
            position: absolute;
            z-index: 3;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.8);
            opacity: 0.9;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }
        
        .star {
            position: absolute;
            width: 2px;
            height: 2px;
            background-color: white;
            border-radius: 50%;
            z-index: 2;
            opacity: 0;
            transition: opacity 2s;
            box-shadow: 0 0 2px white;
        }
        
        #ground {
            position: absolute;
            width: 100%;
            height: 100px;
            bottom: 0;
            background: linear-gradient(to bottom, #3a8040, #2d6a31);
            z-index: 4;
        }
        
        .building {
            position: absolute;
            bottom: 100px;
            z-index: 3;
            background: linear-gradient(to bottom, #546E7A, #37474F);
            border-radius: 2px 2px 0 0;
        }
        
        .tree {
            position: absolute;
            bottom: 100px;
            z-index: 3;
        }
        
        .tree-trunk {
            width: 10px;
            height: 30px;
            background-color: #5D4037;
            margin: 0 auto;
        }
        
        .tree-top {
            width: 40px;
            height: 60px;
            background-color: #2E7D32;
            border-radius: 50% 50% 5% 5%;
            margin: -5px auto 0;
        }
        
        .platform {
            position: absolute;
            height: 15px;
            z-index: 5;
            border-radius: 4px;
            background-color: #8D6E63;
            box-shadow: 0 3px 0 rgba(0, 0, 0, 0.2);
            transition: background-color 0.5s;
        }
        
        .platform.moving {
            animation: movePlatform 5s linear infinite alternate;
        }
        
        .platform.breakable {
            background-color: #FFAB91;
        }
        
        .platform.bouncy {
            background-color: #AED581;
        }
        
        .power-up {
            position: absolute;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            z-index: 5;
            animation: float 2s ease-in-out infinite;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }
        
        .jetpack {
            background: radial-gradient(circle, #FFD600 30%, #FF9800 100%);
        }
        
        .shield {
            background: radial-gradient(circle, #90CAF9 30%, #2196F3 100%);
        }
        
        .coin {
            background: radial-gradient(circle, #FFF59D 30%, #FFD600 100%);
            width: 20px;
            height: 20px;
        }
        
        #player {
            position: absolute;
            width: 50px;
            height: 50px;
            z-index: 10;
            transform: translateX(-50%);
            transition: transform 0.1s;
        }
        
        #score-display {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 18px;
            z-index: 20;
        }
        
        #altitude-display {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 18px;
            z-index: 20;
        }
        
        #altitude-indicator {
            position: absolute;
            right: 20px;
            top: 60px;
            width: 20px;
            height: 60%;
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            z-index: 20;
            overflow: hidden;
        }
        
        #altitude-bar {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 0%;
            background: linear-gradient(to top, #4CAF50, #8BC34A, #FFEB3B, #FF9800, #F44336);
            border-radius: 10px;
            transition: height 0.5s;
        }
        
        #moon-indicator {
            position: absolute;
            right: 20px;
            top: 30px;
            width: 20px;
            height: 20px;
            background-color: white;
            border-radius: 50%;
            z-index: 21;
        }
        
        #game-over {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            display: none;
            z-index: 100;
            backdrop-filter: blur(5px);
        }
        
        #restart-button {
            margin-top: 20px;
            padding: 10px 20px;
            background-color: #4CAF50;
            border: none;
            color: white;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        #instructions {
            position: absolute;
            bottom: 20px;
            left: 0;
            width: 100%;
            text-align: center;
            color: white;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 10px;
            font-size: 14px;
            z-index: 20;
        }
        
        #start-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        
        #start-screen h1 {
            color: white;
            font-size: 36px;
            margin-bottom: 20px;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }
        
        #start-button {
            padding: 15px 30px;
            background-color: #4CAF50;
            border: none;
            color: white;
            font-size: 20px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        #sound-controls {
            position: absolute;
            bottom: 70px;
            right: 20px;
            z-index: 20;
            display: flex;
            gap: 10px;
        }
        
        .sound-button {
            width: 40px;
            height: 40px;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            cursor: pointer;
            font-size: 20px;
            line-height: 40px;
            text-align: center;
        }
        
        .sound-button.active {
            background-color: rgba(76, 175, 80, 0.7);
        }
        
        .sound-button.muted {
            background-color: rgba(244, 67, 54, 0.7);
        }
        
        #level-indicator {
            position: absolute;
            top: 50px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 16px;
            z-index: 20;
            opacity: 0;
            transition: opacity 1s;
        }
        
        .particle {
            position: absolute;
            width: 5px;
            height: 5px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 15;
        }
        
        @keyframes movePlatform {
            0% { transform: translateX(0); }
            100% { transform: translateX(100px); }
        }
        
        @keyframes float {
            0% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0); }
        }
        
        @keyframes blink {
            0% { opacity: 0.2; }
            50% { opacity: 1; }
            100% { opacity: 0.2; }
        }
        
        @media (max-width: 600px) {
            #score-display, #altitude-display {
                font-size: 14px;
                padding: 5px;
            }
            
            #level-indicator {
                font-size: 14px;
                padding: 5px;
            }
            
            #altitude-indicator {
                width: 15px;
                right: 10px;
            }
            
            #instructions {
                font-size: 12px;
            }
            
            #player {
                width: 40px;
                height: 40px;
            }
            
            .sound-button {
                width: 35px;
                height: 35px;
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="game-world">
            <div id="sky-bg"></div>
            <div id="sun"></div>
            <div id="moon"></div>
            <img id="player" src="images/placeholder.png" alt="Player">
            <div id="ground"></div>
        </div>
        
        <div id="score-display">Score: 0</div>
        <div id="altitude-display">Altitude: 0m</div>
        <div id="altitude-indicator">
            <div id="altitude-bar"></div>
        </div>
        <div id="moon-indicator"></div>
        <div id="level-indicator">Level: Ground</div>
        <div id="instructions">Tap left side to move left, right side to move right</div>
        
        <div id="sound-controls">
            <div id="music-toggle" class="sound-button active">♫</div>
            <div id="sfx-toggle" class="sound-button active">♪</div>
        </div>
        
        <div id="game-over">
            <h2>Game Over!</h2>
            <p>You reached: <span id="final-altitude">0</span> meters</p>
            <p>Final score: <span id="final-score">0</span></p>
            <button id="restart-button">Play Again</button>
        </div>
        
        <div id="start-screen">
            <h1>MOON JUMPER</h1>
            <p style="color: white; margin-bottom: 20px;">Jump as high as you can to reach the moon!</p>
            <button id="start-button">Start Game</button>
        </div>
    </div>

    <script>
        // Game variables
        let gameRunning = false;
        let playerX = window.innerWidth / 2;
        let playerY = window.innerHeight - 150;
        let playerVelocityY = 0;
        let playerVelocityX = 0;
        let gravity = 0.3;
        let jumpForce = -13;
        let isJumping = false;
        let score = 0;
        let altitude = 0;
        let maxAltitude = 0;
        let viewportOffset = 0;
        let platforms = [];
        let buildings = [];
        let trees = [];
        let clouds = [];
        let stars = [];
        let powerUps = [];
        let coins = [];
        let currentLevel = 0;
        let levelNames = ["Ground", "Sky", "Clouds", "Stratosphere", "Space"];
        let moonHeight = 50000;
        let hasJetpack = false;
        let jetpackTime = 0;
        let hasShield = false;
        let shieldTime = 0;
        
        // DOM elements
        const gameContainer = document.getElementById('game-container');
        const gameWorld = document.getElementById('game-world');
        const player = document.getElementById('player');
        const ground = document.getElementById('ground');
        const scoreDisplay = document.getElementById('score-display');
        const altitudeDisplay = document.getElementById('altitude-display');
        const altitudeBar = document.getElementById('altitude-bar');
        const gameOverScreen = document.getElementById('game-over');
        const finalAltitude = document.getElementById('final-altitude');
        const finalScore = document.getElementById('final-score');
        const restartButton = document.getElementById('restart-button');
        const startScreen = document.getElementById('start-screen');
        const startButton = document.getElementById('start-button');
        const levelIndicator = document.getElementById('level-indicator');
        const skyBg = document.getElementById('sky-bg');
        const sun = document.getElementById('sun');
        const moon = document.getElementById('moon');
        const musicToggle = document.getElementById('music-toggle');
        const sfxToggle = document.getElementById('sfx-toggle');
        
        // Platform settings
        const platformWidth = 70;
        const platformHeight = 15;
        const minPlatformGap = 60;
        const maxPlatformGap = 100;
        
        // Audio setup
        let musicEnabled = true;
        let sfxEnabled = true;
        let audioContext;
        let sounds = {};
        
        // Initialize audio
        function initAudio() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // Create simple sounds
                sounds.jump = () => {
                    if (!sfxEnabled || !audioContext) return;
                    
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(380, audioContext.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(600, audioContext.currentTime + 0.1);
                    
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.2);
                };
                
                sounds.coin = () => {
                    if (!sfxEnabled || !audioContext) return;
                    
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(880, audioContext.currentTime);
                    
                    gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.3);
                };
                
                sounds.powerup = () => {
                    if (!sfxEnabled || !audioContext) return;
                    
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(880, audioContext.currentTime + 0.3);
                    
                    gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4);
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.4);
                };
                
                sounds.gameOver = () => {
                    if (!sfxEnabled || !audioContext) return;
                    
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(400, audioContext.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(200, audioContext.currentTime + 0.5);
                    
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.6);
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.6);
                };
                
                sounds.levelUp = () => {
                    if (!sfxEnabled || !audioContext) return;
                    
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
                    oscillator.frequency.setValueAtTime(554, audioContext.currentTime + 0.1);
                    oscillator.frequency.setValueAtTime(659, audioContext.currentTime + 0.2);
                    
                    gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.5);
                };
                
                // Setup audio control buttons
                musicToggle.addEventListener('click', () => {
                    musicEnabled = !musicEnabled;
                    if (musicEnabled) {
                        musicToggle.classList.remove('muted');
                        musicToggle.classList.add('active');
                    } else {
                        musicToggle.classList.remove('active');
                        musicToggle.classList.add('muted');
                    }
                });
                
                sfxToggle.addEventListener('click', () => {
                    sfxEnabled = !sfxEnabled;
                    if (sfxEnabled) {
                        sfxToggle.classList.remove('muted');
                        sfxToggle.classList.add('active');
                    } else {
                        sfxToggle.classList.remove('active');
                        sfxToggle.classList.add('muted');
                    }
                });
            } catch (e) {
                console.log("Audio not supported:", e);
            }
        }
        
        // Initialize the game
        function init() {
            // First time setup
            if (!audioContext) {
                initAudio();
            }
            
            // Clean up any existing elements
            document.querySelectorAll('.platform:not(#ground), .building, .tree, .cloud, .star, .power-up, .coin, .particle').forEach(el => {
                if (el.parentNode) {
                    el.parentNode.removeChild(el);
                }
            });
            
            // Reset game variables
            gameRunning = true;
            playerX = window.innerWidth / 2;
            playerY = window.innerHeight - 120;
            playerVelocityY = 0;
            playerVelocityX = 0;
            score = 0;
            altitude = 0;
            maxAltitude = 0;
            viewportOffset = 0;
            currentLevel = 0;
            platforms = [];
            buildings = [];
            trees = [];
            clouds = [];
            stars = [];
            powerUps = [];
            coins = [];
            hasJetpack = false;
            jetpackTime = 0;
            hasShield = false;
            shieldTime = 0;
            
            // Reset UI
            scoreDisplay.textContent = `Score: ${score}`;
            altitudeDisplay.textContent = `Altitude: ${altitude}m`;
            altitudeBar.style.height = '0%';
            
            // Reset game world position
            gameWorld.style.transform = 'translateY(0)';
            
            // Create initial elements
            createStars();
            createInitialBuildings();
            createInitialTrees();
            createInitialPlatforms();
            createInitialClouds();
            
            // Create start platform
            const startPlatform = document.createElement('div');
            startPlatform.className = 'platform';
            startPlatform.style.width = '100px';
            startPlatform.style.left = `${playerX - 50}px`;
            startPlatform.style.bottom = `${playerY - 10}px`;
            gameWorld.appendChild(startPlatform);
            
            platforms.push({
                x: playerX - 50,
                y: playerY - 10,
                width: 100,
                element: startPlatform,
                type: 'normal',
                active: true
            });
            
            // Set initial player position
            player.style.left = `${playerX}px`;
            player.style.bottom = `${playerY}px`;
            
            // Play start sound
            if (sfxEnabled && sounds.jump) {
                sounds.jump();
            }
            
            // Start game loop
            requestAnimationFrame(gameLoop);
        }
        
        // Create buildings
        function createInitialBuildings() {
            for (let i = 0; i < 10; i++) {
                createBuilding(Math.random() * window.innerWidth);
            }
        }
        
        function createBuilding(x) {
            const building = document.createElement('div');
            building.className = 'building';
            
            const height = 50 + Math.random() * 150;
            const width = 30 + Math.random() * 50;
            
            building.style.left = `${x}px`;
            building.style.width = `${width}px`;
            building.style.height = `${height}px`;
            
            gameWorld.appendChild(building);
            buildings.push({
                element: building,
                x: x,
                y: 0,
                width: width,
                height: height
            });
        }
        
        // Create trees
        function createInitialTrees() {
            for (let i = 0; i < 15; i++) {
                createTree(Math.random() * window.innerWidth);
            }
        }
        
        function createTree(x) {
            const tree = document.createElement('div');
            tree.className = 'tree';
            
            const trunk = document.createElement('div');
            trunk.className = 'tree-trunk';
            
            const top = document.createElement('div');
            top.className = 'tree-top';
            
            tree.appendChild(top);
            tree.appendChild(trunk);
            
            tree.style.left = `${x}px`;
            
            gameWorld.appendChild(tree);
            trees.push({
                element: tree,
                x: x,
                y: 0
            });
        }
        
        // Create platforms
        function createInitialPlatforms() {
            const groundPlatform = {
                x: 0,
                y: 100,
                width: window.innerWidth,
                element: ground,
                type: 'normal',
                active: true
            };
            platforms.push(groundPlatform);
            
            // More frequent platforms at the beginning
            for (let y = window.innerHeight - 200; y > window.innerHeight - 600; y -= 60) {
                createPlatform(y);
            }
            
            // Normal spacing after that
            for (let y = window.innerHeight - 600; y > -1000; y -= (minPlatformGap + Math.random() * (maxPlatformGap - minPlatformGap))) {
                createPlatform(y);
            }
        }
        
        function createPlatform(y, forceType = null) {
            const platform = document.createElement('div');
            platform.className = 'platform';
            
            const width = platformWidth * (0.7 + Math.random() * 0.6);
            const x = Math.random() * (window.innerWidth - width);
            
            platform.style.width = `${width}px`;
            platform.style.left = `${x}px`;
            platform.style.bottom = `${y}px`;
            
            let type = forceType;
            if (!type) {
                const typeRoll = Math.random();
                if (y > 1000 && typeRoll < 0.1) {
                    type = 'moving';
                    platform.classList.add('moving');
                } else if (y > 2000 && typeRoll < 0.2) {
                    type = 'breakable';
                    platform.classList.add('breakable');
                } else if (y > 3000 && typeRoll < 0.3) {
                    type = 'bouncy';
                    platform.classList.add('bouncy');
                } else {
                    type = 'normal';
                }
            } else {
                platform.classList.add(forceType);
            }
            
            // Change platform color based on altitude
            if (y > 5000 && y <= 15000) {
                platform.style.backgroundColor = "#78909C"; // Mid-altitude color
            } else if (y > 15000) {
                platform.style.backgroundColor = "#E0E0E0"; // High-altitude color
            }
            
            gameWorld.appendChild(platform);
            
            // Add platform to array
            platforms.push({
                x: x,
                y: y,
                width: width,
                element: platform,
                type: type,
                active: true
            });
            
            // Add power-ups or coins
            if (y > 1000) {
                if (Math.random() < 0.05) {
                    createPowerUp(x + width / 2, y + 30);
                } else if (Math.random() < 0.2) {
                    createCoin(x + width / 2, y + 30);
                }
            }
            
            return platform;
        }
        
        // Create clouds
        function createInitialClouds() {
            for (let i = 0; i < 10; i++) {
                createCloud(
                    Math.random() * window.innerWidth,
                    500 + Math.random() * 4000
                );
            }
        }
        
        function createCloud(x, y) {
            const cloud = document.createElement('div');
            cloud.className = 'cloud';
            
            const size = 50 + Math.random() * 100;
            cloud.style.width = `${size}px`;
            cloud.style.height = `${size / 2}px`;
            cloud.style.left = `${x}px`;
            cloud.style.bottom = `${y}px`;
            
            gameWorld.appendChild(cloud);
            clouds.push({
                element: cloud,
                x: x,
                y: y,
                size: size
            });
        }
        
        // Create stars
        function createStars() {
            for (let i = 0; i < 100; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                
                const x = Math.random() * window.innerWidth;
                const y = 10000 + Math.random() * 40000;
                
                star.style.left = `${x}px`;
                star.style.bottom = `${y}px`;
                
                if (Math.random() < 0.2) {
                    star.style.width = '3px';
                    star.style.height = '3px';
                    star.style.boxShadow = '0 0 3px 1px white';
                }
                
                if (Math.random() < 0.1) {
                    star.style.animation = `blink ${2 + Math.random() * 3}s infinite`;
                }
                
                gameWorld.appendChild(star);
                stars.push({
                    element: star,
                    x: x,
                    y: y
                });
            }
        }
        
        // Create power-ups
        function createPowerUp(x, y) {
            const powerUp = document.createElement('div');
            powerUp.className = 'power-up';
            
            let type;
            if (Math.random() < 0.5) {
                type = 'jetpack';
                powerUp.classList.add('jetpack');
            } else {
                type = 'shield';
                powerUp.classList.add('shield');
            }
            
            powerUp.style.left = `${x}px`;
            powerUp.style.bottom = `${y}px`;
            
            gameWorld.appendChild(powerUp);
            powerUps.push({
                element: powerUp,
                x: x,
                y: y,
                type: type
            });
        }
        
        // Create coins
        function createCoin(x, y) {
            const coin = document.createElement('div');
            coin.className = 'coin';
            
            coin.style.left = `${x}px`;
            coin.style.bottom = `${y}px`;
            
            gameWorld.appendChild(coin);
            coins.push({
                element: coin,
                x: x,
                y: y
            });
        }
        
        // Create particles
        function createParticles(x, y, count, color) {
            for (let i = 0; i < count; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = `${x}px`;
                particle.style.bottom = `${y}px`;
                particle.style.backgroundColor = color;
                
                const size = 2 + Math.random() * 5;
                particle.style.width = `${size}px`;
                particle.style.height = `${size}px`;
                
                const angle = Math.random() * Math.PI * 2;
                const speed = 1 + Math.random() * 3;
                const velocityX = Math.cos(angle) * speed;
                const velocityY = Math.sin(angle) * speed;
                
                gameWorld.appendChild(particle);
                
                let opacity = 1;
                const animateParticle = () => {
                    if (opacity <= 0) {
                        if (particle.parentNode) {
                            particle.parentNode.removeChild(particle);
                        }
                        return;
                    }
                    
                    const currentX = parseFloat(particle.style.left);
                    const currentY = parseFloat(particle.style.bottom);
                    
                    particle.style.left = `${currentX + velocityX}px`;
                    particle.style.bottom = `${currentY + velocityY}px`;
                    
                    opacity -= 0.02;
                    particle.style.opacity = opacity;
                    
                    requestAnimationFrame(animateParticle);
                };
                
                requestAnimationFrame(animateParticle);
            }
        }
        
        // Platform collision detection
        function isOnPlatform() {
            if (playerVelocityY < -2) return false;
            
            const playerFeet = playerY - 5;
            
            for (let i = 0; i < platforms.length; i++) {
                const platform = platforms[i];
                
                if (platform.type === 'breakable' && !platform.active) continue;
                
                if (
                    playerX >= platform.x && 
                    playerX <= platform.x + platform.width &&
                    playerFeet <= platform.y + platformHeight + 10 &&
                    playerFeet >= platform.y - 10
                ) {
                    if (platform.type === 'breakable') {
                        breakPlatform(platform);
                        return false;
                    } else if (platform.type === 'bouncy') {
                        jumpForce = -18;
                        createParticles(playerX, playerY, 10, '#AED581');
                    } else {
                        jumpForce = -13;
                    }
                    
                    return platform;
                }
            }
            
            return false;
        }
        
        // Break platform
        function breakPlatform(platform) {
            platform.active = false;
            platform.element.style.opacity = '0.5';
            createParticles(platform.x + platform.width / 2, platform.y, 15, '#FFAB91');
            
            setTimeout(() => {
                if (platform.element.parentNode) {
                    platform.element.parentNode.removeChild(platform.element);
                }
                platforms = platforms.filter(p => p !== platform);
            }, 300);
        }
        
        // Power-up collision
        function checkPowerUpCollision() {
            for (let i = 0; i < powerUps.length; i++) {
                const powerUp = powerUps[i];
                
                if (
                    Math.abs(playerX - powerUp.x) < 30 &&
                    Math.abs(playerY - powerUp.y) < 30
                ) {
                    if (powerUp.element.parentNode) {
                        powerUp.element.parentNode.removeChild(powerUp.element);
                    }
                    
                    if (powerUp.type === 'jetpack') {
                        hasJetpack = true;
                        jetpackTime = 300;
                        createParticles(playerX, playerY - 20, 20, '#FF9800');
                        score += 30;
                        if (sfxEnabled && sounds.powerup) sounds.powerup();
                    } else if (powerUp.type === 'shield') {
                        hasShield = true;
                        shieldTime = 600;
                        createParticles(playerX, playerY, 20, '#2196F3');
                        score += 20;
                        if (sfxEnabled && sounds.powerup) sounds.powerup();
                    }
                    
                    powerUps.splice(i, 1);
                    i--;
                    
                    scoreDisplay.textContent = `Score: ${score}`;
                }
            }
        }
        
        // Coin collision
        function checkCoinCollision() {
            for (let i = 0; i < coins.length; i++) {
                const coin = coins[i];
                
                if (
                    Math.abs(playerX - coin.x) < 25 &&
                    Math.abs(playerY - coin.y) < 25
                ) {
                    if (coin.element.parentNode) {
                        coin.element.parentNode.removeChild(coin.element);
                    }
                    
                    createParticles(coin.x, coin.y, 10, '#FFD600');
                    
                    if (sfxEnabled && sounds.coin) sounds.coin();
                    
                    score += 10;
                    scoreDisplay.textContent = `Score: ${score}`;
                    
                    coins.splice(i, 1);
                    i--;
                }
            }
        }
        
        // Update moving platforms
        function updatePlatforms() {
            for (let i = 0; i < platforms.length; i++) {
                const platform = platforms[i];
                
                if (platform.type === 'moving') {
                    const transform = window.getComputedStyle(platform.element).getPropertyValue('transform');
                    if (transform && transform !== 'none') {
                        const matrix = new DOMMatrix(transform);
                        platform.x = parseFloat(platform.element.style.left) + matrix.m41;
                    }
                }
            }
        }
        
        // Generate new content
        function generateContent() {
            const visibleTop = viewportOffset + window.innerHeight;
            const highestPlatform = Math.max(...platforms.map(p => p.y));
            
            if (highestPlatform < visibleTop + 1000) {
                for (let y = highestPlatform + minPlatformGap; y < visibleTop + 2000; y += (minPlatformGap + Math.random() * (maxPlatformGap - minPlatformGap))) {
                    createPlatform(y);
                }
            }
            
            if (altitude > 500 && clouds.length < 20 && Math.random() < 0.02) {
                createCloud(
                    Math.random() * window.innerWidth,
                    viewportOffset + window.innerHeight + Math.random() * 500
                );
            }
        }
        
        // Update game level
        function updateLevel() {
            let newLevel = 0;
            
            if (altitude > 1000 && altitude <= 5000) {
                newLevel = 1; // Sky
            } else if (altitude > 5000 && altitude <= 15000) {
                newLevel = 2; // Clouds
            } else if (altitude > 15000 && altitude <= 30000) {
                newLevel = 3; // Stratosphere
            } else if (altitude > 30000) {
                newLevel = 4; // Space
            }
            
            if (newLevel !== currentLevel) {
                currentLevel = newLevel;
                levelIndicator.textContent = `Level: ${levelNames[currentLevel]}`;
                levelIndicator.style.opacity = '1';
                
                if (sfxEnabled && sounds.levelUp) sounds.levelUp();
                
                setTimeout(() => {
                    levelIndicator.style.opacity = '0';
                }, 3000);
                
                // Visual changes
                switch (currentLevel) {
                    case 3:
                        stars.forEach(star => {
                            if (star.y <= altitude + 2000) {
                                star.element.style.opacity = '1';
                            }
                        });
                        break;
                    case 4:
                        stars.forEach(star => {
                            star.element.style.opacity = '1';
                        });
                        break;
                }
            }
            
            // Show stars gradually
            if (altitude > 10000) {
                stars.forEach(star => {
                    if (star.y <= altitude + 2000) {
                        star.element.style.opacity = '1';
                    }
                });
            }
            
            // Update progress bar
            const progress = Math.min((altitude / moonHeight) * 100, 100);
            altitudeBar.style.height = `${progress}%`;
            
            // Move sun and moon
            if (altitude > 1000) {
                const sunY = 50 - (altitude / 500);
                sun.style.top = `${Math.max(sunY, -100)}px`;
                
                if (altitude > 30000) {
                    const moonY = -120 + ((altitude - 30000) / 200);
                    moon.style.top = `${Math.min(moonY, 50)}px`;
                }
            }
            
            // Change background
            if (altitude < 10000) {
                const blueRatio = Math.min(altitude / 10000, 1);
                skyBg.style.background = `linear-gradient(to top, 
                    #87CEEB ${10 - blueRatio * 10}%, 
                    #1a237e ${60 - blueRatio * 20}%, 
                    #0a0a2a ${85 - blueRatio * 15}%)`;
            } else if (altitude >= 10000 && altitude < 30000) {
                const spaceRatio = Math.min((altitude - 10000) / 20000, 1);
                skyBg.style.background = `linear-gradient(to top, 
                    #1a237e ${10 - spaceRatio * 10}%, 
                    #0a0a2a ${60 - spaceRatio * 30}%)`;
            } else {
                skyBg.style.backgroundColor = '#0a0a2a';
            }
        }
        
        // Game loop
        function gameLoop() {
            if (!gameRunning) return;
            
            // Apply gravity or jetpack
            if (hasJetpack && jetpackTime > 0) {
                playerVelocityY = -5;
                jetpackTime--;
                
                if (gameLoop.frame % 2 === 0) {
                    createParticles(playerX, playerY - 20, 2, '#FF9800');
                }
                
                if (jetpackTime <= 0) {
                    hasJetpack = false;
                }
            } else {
                playerVelocityY += gravity;
                if (playerVelocityY > 12) playerVelocityY = 12;
            }
            
            // Shield countdown
            if (hasShield && shieldTime > 0) {
                shieldTime--;
                if (shieldTime <= 0) {
                    hasShield = false;
                }
            }
            
            // Update player position
            playerY -= playerVelocityY;
            playerX += playerVelocityX;
            
            // Screen boundaries
            if (playerX < 25) playerX = 25;
            if (playerX > window.innerWidth - 25) playerX = window.innerWidth - 25;
            
            // Platform collision
            const platform = isOnPlatform();
            if (platform) {
                playerY = platform.y + platformHeight;
                playerVelocityY = jumpForce;
                isJumping = true;
                
                if (sfxEnabled && sounds.jump) sounds.jump();
                
                createParticles(playerX, playerY, 5, '#ffffff');
                
                player.animate([
                    { transform: 'translateX(-50%) scaleY(0.8)' },
                    { transform: 'translateX(-50%) scaleY(1.1)' },
                    { transform: playerVelocityX < 0 ? 'translateX(-50%) scaleX(-1)' : 'translateX(-50%) scaleX(1)' }
                ], {
                    duration: 300,
                    easing: 'ease-out'
                });
            }
            
            // Check collisions
            checkPowerUpCollision();
            checkCoinCollision();
            updatePlatforms();
            
            // Update altitude
            altitude = playerY;
            maxAltitude = Math.max(maxAltitude, altitude);
            altitudeDisplay.textContent = `Altitude: ${Math.floor(altitude)}m`;
            
            // Generate content and update level
            generateContent();
            updateLevel();
            
            // Add shield at start
            if (gameLoop.frame < 100 && !hasShield) {
                hasShield = true;
                shieldTime = 100;
            }
            
            // Check if player fell
            if (playerY < viewportOffset - 150) {
                if (hasShield) {
                    hasShield = false;
                    shieldTime = 0;
                    playerY = viewportOffset + 100;
                    playerVelocityY = jumpForce;
                    createParticles(playerX, playerY, 20, '#2196F3');
                } else {
                    gameOver();
                    return;
                }
            }
            
            // Check win condition
            if (altitude >= moonHeight) {
                gameRunning = false;
                finalAltitude.textContent = Math.floor(maxAltitude);
                finalScore.textContent = score + 1000;
                document.querySelector('#game-over h2').textContent = 'You Reached the Moon!';
                gameOverScreen.style.display = 'block';
                return;
            }
            
            // Camera follow
            const idealOffset = playerY - window.innerHeight / 3;
            if (idealOffset > viewportOffset) {
                viewportOffset += (idealOffset - viewportOffset) * 0.1;
                gameWorld.style.transform = `translateY(${viewportOffset}px)`;
            }
            
            // Update player visual
            player.style.left = `${playerX}px`;
            player.style.bottom = `${playerY}px`;
            
            if (hasJetpack) {
                player.style.filter = 'drop-shadow(0 0 10px #FF9800)';
            } else if (hasShield) {
                player.style.filter = 'drop-shadow(0 0 10px #2196F3)';
            } else {
                player.style.filter = 'none';
            }
            
            // Continue game loop
            gameLoop.frame = (gameLoop.frame || 0) + 1;
            requestAnimationFrame(gameLoop);
        }
        
        // Game over
        function gameOver() {
            gameRunning = false;
            finalAltitude.textContent = Math.floor(maxAltitude);
            finalScore.textContent = score;
            gameOverScreen.style.display = 'block';
            
            if (sfxEnabled && sounds.gameOver) sounds.gameOver();
            
            createParticles(playerX, playerY, 30, '#F44336');
        }
        
        // Touch controls
        function handleTouchMove(e) {
            e.preventDefault();
            
            const touch = e.touches[0];
            const touchX = touch.clientX;
            
            if (touchX < window.innerWidth / 2) {
                playerVelocityX = -4;
                player.style.transform = 'translateX(-50%) scaleX(-1)';
            } else {
                playerVelocityX = 4;
                player.style.transform = 'translateX(-50%) scaleX(1)';
            }
        }
        
        function handleTouchEnd() {
            playerVelocityX = 0;
        }
        
        // Keyboard controls
        function handleKeyDown(e) {
            if (e.key === 'ArrowLeft') {
                playerVelocityX = -4;
                player.style.transform = 'translateX(-50%) scaleX(-1)';
            } else if (e.key === 'ArrowRight') {
                playerVelocityX = 4;
                player.style.transform = 'translateX(-50%) scaleX(1)';
            }
        }
        
        function handleKeyUp(e) {
            if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
                playerVelocityX = 0;
            }
        }
        
        // Event listeners
        document.addEventListener('touchmove', handleTouchMove, { passive: false });
        document.addEventListener('touchend', handleTouchEnd);
        document.addEventListener('keydown', handleKeyDown);
        document.addEventListener('keyup', handleKeyUp);
        
        restartButton.addEventListener('click', () => {
            gameOverScreen.style.display = 'none';
            init();
        });
        
        startButton.addEventListener('click', () => {
            if (audioContext && audioContext.state === 'suspended') {
                audioContext.resume();
            }
            
            startScreen.style.display = 'none';
            init();
        });
    </script>
</body>
</html>
